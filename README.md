
```markdown
# AstrBot 性别识别插件 v0.0.2

自动识别用户性别并在 LLM 请求时插入相应提示词的插件。

## 新功能

- 支持通过 @用户 查询他人性别信息
- 增强的调试模式
- 优化的缓存机制

## 功能特性

- 🔍 自动识别用户性别（支持 QQ 平台）
- 👥 支持查询他人性别（通过@功能）
- 💾 性别信息缓存，避免重复 API 调用
- 🎯 根据性别在 LLM prompt 中插入不同提示词
- 🗣️ 支持自定义敬语称呼
- 🐛 调试模式，方便排查问题
- ⚡ 高性能缓存机制

## 使用方法

### 基础命令

- `/gender` - 查看自己的性别识别结果
- `/gender @用户` - 查看被@用户的性别信息
- `/gender_cache` - 查看缓存信息（需启用调试模式）
- `/gender_clear_cache` - 清除所有缓存（需启用调试模式）
- `/gender_debug` - 查看详细调试信息（需启用调试模式）

### 使用示例

1. 查询自己的性别:
   ```
   /gender
   ```

2. 查询他人的性别:
   ```
   /gender @张三
   ```

3. 同时查询多人（只显示第一个被@的人）:
   ```
   /gender @张三 @李四
   ```

### 配置说明

在 AstrBot 管理面板中可以配置以下选项：

1. **基础设置**
   - `enable_plugin`: 是否启用插件
   - `enable_debug`: 是否启用调试模式（重要：开启后才能使用缓存管理功能）

2. **提示词设置**
   - `male_prompt`: 男性用户的提示词
   - `female_prompt`: 女性用户的提示词
   - `unknown_prompt`: 性别未知时的提示词
   - `prompt_position`: 提示词插入位置（prefix/suffix）

3. **敬语设置**
   - `enable_honorific`: 是否启用敬语
   - `male_honorific`: 男性敬语（如"先生"）
   - `female_honorific`: 女性敬语（如"女士"）
   - `unknown_honorific`: 性别未知时的称呼

4. **缓存设置**
   - `cache_expire_hours`: 缓存过期时间（小时）

## 工作原理

1. 用户发送消息时，插件会尝试获取其性别信息
2. 优先从本地缓存读取，缓存未命中则调用平台 API
3. 在 LLM 请求前，根据性别插入相应的提示词
4. 支持在提示词中加入敬语称呼
5. 支持通过@查询其他用户的性别信息

## 支持平台

- ✅ QQ (通过 aiocqhttp/NapCat/Lagrange)
- ❌ 其他平台暂不支持

## 更新日志

### v0.0.2
- 新增: 支持通过@用户查询他人性别
- 优化: 提取@信息的逻辑
- 优化: API调用错误处理
- 改进: 缓存机制的稳定性

### v0.0.1
- 初始版本发布
- 基础性别识别功能
- 缓存机制
- 调试模式

## 注意事项

- 性别信息来自平台 API，可能存在用户未设置或设置为保密的情况
- 缓存文件存储在 `data/gender_cache.json`
- 建议定期清理过期缓存以节省存储空间
- 调试模式下会输出更多日志信息，建议仅在需要时开启
```

### requirements.txt

```txt
# 本插件不需要额外依赖
```

## 主要更新内容

1. **新增@查询功能**:
   - 支持 `/gender @用户` 查询他人性别
   - 自动从消息链中提取@信息
   - 获取被@用户的昵称和性别

2. **改进的API调用**:
   - 新增 `_get_user_gender_by_id` 方法专门处理通过ID查询
   - 优化错误处理机制
   - 支持获取他人昵称信息

3. **增强的调试功能**:
   - 调试信息更加详细
   - 缓存管理更加完善

4. **更好的用户体验**:
   - 查询结果根据查询对象不同显示不同信息
   - 查询自己时显示更多配置信息
   - 查询他人时只显示基本信息

这个插件现在支持所有你要求的功能，可以识别用户性别、支持@查询他人、具有调试开关、并且有完善的缓存机制。
